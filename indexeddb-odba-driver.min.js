/*! indexeddb-odba-driver - 0.5.0 (2014-12-22) */!function(){function Combinator(){}function Connection(config){Object.defineProperty(this,"config",{value:config,enumerable:!0})}function Database(){}function Driver(name){Object.defineProperty(this,"name",{value:name,enumerable:!0})}function Index(){}function Query(){}function Result(rows){Object.defineProperty(this,"rows",{value:rows})}function ResultFilter(){}function Server(){}function Table(){}Combinator.prototype.join=function(source,target,sourceCol,targetCol,opts){var arrayAgg,res=[],util=odba.util;arrayAgg=opts.arrayAgg;for(var i=0;i<source.length;++i){for(var srcRow=util._extend({},source[i]),arrAgg=srcRow[arrayAgg]=[],j=0;j<target.length;++j){var tgtRow=util._extend(target[j]);srcRow[sourceCol]==tgtRow[targetCol]&&arrAgg.push(tgtRow)}res.push(srcRow)}return res},Connection.prototype.clone=function(){throw new Error("Abstract method.")},Connection.prototype.__defineGetter__("connected",function(){throw new Error("Abstract property.")}),Connection.prototype.__defineGetter__("server",function(){throw new Error("Abstract property.")}),Connection.prototype.open=function(){throw new Error("Abstract method.")},Connection.prototype.close=function(){throw new Error("Abstract method.")},Connection.prototype.runTransaction=function(){throw new Error("Abstract method.")},Database.prototype.__defineGetter__("name",function(){throw new Error("Abstract property.")}),Database.prototype.hasTable=function(){throw new Error("Abstract method.")},Database.prototype.hasTables=function(){throw new Error("Abstract method.")},Database.prototype.findTable=function(){throw new Error("Abstract method.")},Database.prototype.createTable=function(){throw new Error("Abstract method.")},Database.prototype.createTables=function(){throw new Error("Abstract method.")},Database.prototype.dropTable=function(){throw new Error("Abstract method.")},Database.prototype.findIndex=function(){throw new Error("Abstract method.")},Database.prototype.hasIndex=function(){throw new Error("Abstract method.")},Database.prototype.createIndex=function(){throw new Error("Abstract method.")},Database.prototype.dropIndex=function(){throw new Error("Abstract method.")},Object.defineProperty(Driver,"cache",{value:{}}),Driver.getDriver=function(name){var cache=odba.Driver.cache;if(!name)throw new Error("Driver name expected.");return cache[name.toLowerCase()]},Driver.register=function(driver,alias){var cache=odba.Driver.cache;if(!driver)throw new Error("Driver expected.");if(cache[driver.name.toLowerCase()]=driver,alias){"string"==typeof alias&&(alias=[alias]);for(var i=0;i<alias.length;++i)cache[alias[i].toLowerCase()]=driver}},Driver.prototype.createConnection=function(){throw new Error("Abstract method.")},Driver.prototype.openConnection=function(config,callback){var cx;if(!config)throw new Error("Configuration expected.");if(!callback)throw new Error("Callback expected.");cx=this.createConnection(config),cx.open(function(error){error?callback(error):callback(void 0,cx)})},Index.prototype.__defineGetter__("database",function(){throw new Error("Abstract property.")}),Index.prototype.__defineGetter__("table",function(){throw new Error("Abstract property.")}),Index.prototype.__defineGetter__("name",function(){throw new Error("Abstract property.")}),Index.prototype.__defineGetter__("unique",function(){throw new Error("Abstract property.")}),Query.prototype.findAll=function(){throw new Error("Abstract method.")},Query.prototype.find=function(){throw new Error("Abstract method.")},Query.prototype.findOne=function(){throw new Error("Abstract method.")},Query.prototype.join=function(){throw new Error("Abstract method.")},Result.prototype.__defineGetter__("length",function(){return this.rows.length}),Result.prototype.find=function(where){return(new odba.ResultFilter).find(this,where)},ResultFilter.prototype.find=function(result,filter){var filtered=[];filter||(filter={});for(var i=0,rows=result.rows;i<result.length;++i){var row=rows[i];this.check(row,filter)&&filtered.push(row)}return filtered},ResultFilter.prototype.check=function(row,filter){var res=!1,keys=Object.keys(filter);if(0===keys.length)res=!0;else if(1==keys.length)res=this.checkProp(row,keys[0],filter);else{res=!0;for(var i=0,props=keys;i<props.length;++i){var prop=props[i];if(!this.checkProp(row,prop,filter)){res=!1;break}}}return res},ResultFilter.prototype.checkProp=function(row,prop,filter){var res;if(filter=filter[prop],"object"!=typeof filter)res=this.$eq(row,prop,filter);else{var ops=Object.keys(filter);if(0===ops.length)res=!0;else if(1==ops.length)res=this.checkOp(row,prop,ops[0],filter);else{res=!0;for(var i=0;i<ops.length;++i)if(!this.checkOp(row,prop,ops[i],filter)){res=!1;break}}}return res},ResultFilter.prototype.checkOp=function(row,prop,op,filter){var res;if("$eq"==op)res=this.$eq(row,prop,filter.$eq);else if("$ne"==op)res=this.$ne(row,prop,filter.$ne);else if("$lt"==op)res=this.$lt(row,prop,filter.$lt);else if("$le"==op)res=this.$le(row,prop,filter.$le);else if("$gt"==op)res=this.$gt(row,prop,filter.$gt);else if("$ge"==op)res=this.$ge(row,prop,filter.$ge);else if("$like"==op)res=this.$like(row,prop,filter.$like);else if("$notLike"==op)res=this.$notLike(row,prop,filter.$notLike);else if("$in"==op)res=this.$in(row,prop,filter.$in);else{if("$notIn"!=op)throw new Error("Unknown operator: '"+op+"'.");res=this.$notIn(row,prop,filter.$notIn)}return res},ResultFilter.prototype.$eq=function(row,prop,value){return void 0===value?void 0===row[prop]:null===value?null===row[prop]:row[prop]==value},ResultFilter.prototype.$ne=function(row,prop,value){return void 0===value?void 0!==row[prop]:null===value?null!==row[prop]:row[prop]!=value},ResultFilter.prototype.$lt=function(row,prop,value){return void 0===value||null===value?!1:row[prop]<value},ResultFilter.prototype.$le=function(row,prop,value){return void 0===value||null===value?!1:row[prop]<=value},ResultFilter.prototype.$gt=function(row,prop,value){return void 0===value||null===value?!1:row[prop]>value},ResultFilter.prototype.$ge=function(row,prop,value){return void 0===value||null===value?!1:row[prop]>=value},ResultFilter.prototype.$like=function(row,prop,value){return void 0===value||null===value?this.$eq(row,prop,value):new RegExp(value).test(row[prop])},ResultFilter.prototype.$notLike=function(row,prop,value){return void 0===value||null===value?this.$ne(row,prop,value):!this.$like(row,prop,value)},ResultFilter.prototype.$in=function(row,prop,value){return void 0===value||null===value?!1:value.indexOf(row[prop])>=0},ResultFilter.prototype.$notIn=function(row,prop,value){return!this.$in(row,prop,value)},Server.prototype.__defineGetter__("host",function(){throw new Error("Abstract method.")}),Server.prototype.__defineGetter__("port",function(){throw new Error("Abstract method.")}),Server.prototype.__defineGetter__("version",function(){throw new Error("Abstract method.")}),Server.prototype.createDatabase=function(){throw new Error("Abstract method.")},Server.prototype.hasDatabase=function(){throw new Error("Abstract method.")},Server.prototype.dropDatabase=function(){throw new Error("Abstract method.")},Table.prototype.__defineGetter__("database",function(){throw new Error("Abstract method.")}),Table.prototype.__defineGetter__("name",function(){throw new Error("Abstract method.")}),Table.prototype.hasIndex=function(name,callback){if(arguments.length<2)throw new Error("Index name and callback expected.");this.database.hasIndex(this.name,name,callback)},Table.prototype.findIndex=function(name,callback){if(arguments.length<2)throw new Error("Index name and callback expected.");this.database.findIndex(this.name,name,callback)},Table.prototype.createIndex=function(name,col,options,callback){if(arguments.length<2)throw new Error("Index name and indexing column expected.");3==arguments.length&&arguments[2]instanceof Function&&(callback=arguments[2],options={}),this.database.createIndex(this.name,name,col,options,callback)},Table.prototype.dropIndex=function(name,callback){if(arguments.length<1)throw new Error("Index name expected.");this.database.dropIndex(this.name,name,callback)},Table.prototype.find=function(){throw new Error("Abstract method.")},Table.prototype.findAll=function(){throw new Error("Abstract method.")},Table.prototype.findOne=function(){throw new Error("Abstract method.")},Table.prototype.count=function(){throw new Error("Abstract method.")},Table.prototype.join=function(){throw new Error("Abstract method.")},Table.prototype.insert=function(){throw new Error("Abstract method.")},Table.prototype.save=function(){throw new Error("Abstract method.")},Table.prototype.update=function(){throw new Error("Abstract method.")},Table.prototype.remove=function(){throw new Error("Abstract method.")},Object.defineProperty(window,"odba",{value:{},enumerable:!0}),Object.defineProperty(odba,"util",{value:{inherits:function(child,parent){child.super_=parent,child.prototype=Object.create(parent.prototype,{constructor:{value:child,enumerable:!1,writable:!0,configurable:!0}})},_extend:function(origin,add){if("object"==typeof add)for(var i=0,keys=Object.keys(add);i<keys.length;++i){var k=keys[i];origin[k]=add[k]}return origin},getBrowserName:function(){return window.chrome?"Chrome":"Other"}}}),Object.defineProperty(odba,"Combinator",{value:Combinator,enumerable:!0}),Object.defineProperty(odba,"Connection",{value:Connection,enumerable:!0}),Object.defineProperty(odba,"Database",{value:Database,enumerable:!0}),Object.defineProperty(odba,"Driver",{value:Driver,enumerable:!0}),Object.defineProperty(odba,"Index",{value:Index,enumerable:!0}),Object.defineProperty(odba,"Query",{value:Query,enumerable:!0}),Object.defineProperty(odba,"Result",{value:Result,enumerable:!0}),Object.defineProperty(odba,"ResultFilter",{value:ResultFilter,enumerable:!0}),Object.defineProperty(odba,"Server",{value:Server,enumerable:!0}),Object.defineProperty(odba,"Table",{value:Table,enumerable:!0})}(),Object.defineProperty(odba,"indexeddb",{value:{},enumerable:!0}),function(){function IndexedDBConnection(config){Object.defineProperty(this,"config",{value:config}),Object.defineProperty(this,"database",{value:void 0,enumerable:!0,writable:!0}),Object.defineProperty(this,"transaction",{value:void 0,writable:!0});try{Object.defineProperty(this,"indexedDB",{value:Modernizr.indexedDB})}catch(e){Object.defineProperty(this,"indexedDB",{value:window.indexedDB})}}odba.util.inherits(IndexedDBConnection,odba.Connection),Object.defineProperty(odba.indexeddb,"IndexedDBConnection",{value:IndexedDBConnection}),IndexedDBConnection.prototype.__defineGetter__("server",function(){return this._server||Object.defineProperty(this,"_server",{value:new odba.indexeddb.IndexedDBServer(this),writable:!0}),this._server}),IndexedDBConnection.prototype.clone=function(){return new IndexedDBConnection(odba.util._extend({},this.config))},IndexedDBConnection.prototype.__defineGetter__("connected",function(){return void 0!==this.database&&null!==this.database}),IndexedDBConnection.prototype.open=function(callback){var req,self=this,indexedDB=this.indexedDB,IndexedDBDatabase=odba.indexeddb.IndexedDBDatabase;if(this.connected)return void(callback&&callback(void 0,this.database));if(arguments.length<1)throw new Error("Callback expected.");req=this.config.version?indexedDB.open(this.config.database,this.config.version):indexedDB.open(this.config.database),req.onsuccess=function(e){self.database=new IndexedDBDatabase(self,e.target.result),callback&&callback(void 0,self.database)},req.onerror=function(e){callback&&callback(e)}},IndexedDBConnection.prototype.close=function(callback){this.database&&this.database.native&&this.database.native.close(),this.database=void 0,this.transaction=void 0,this.server=void 0,callback&&callback()},IndexedDBConnection.prototype.beginTransaction=function(mode,stores,handlers){var tran,IndexedDBTransaction=odba.indexeddb.IndexedDBTransaction;if(1==arguments.length?arguments[0]instanceof Array?(stores=arguments[0],mode=handlers=void 0):"object"==typeof arguments[0]&&(handlers=arguments[0],mode=stores=void 0):2==arguments.length&&(arguments[0]instanceof Array?(handlers=arguments[1],stores=arguments[0],mode=void 0):arguments[1]instanceof Array||"string"==typeof arguments[1]||(handlers=arguments[1],stores=void 0)),mode=mode||"readwrite","string"==typeof stores&&(stores=[stores]),handlers||(handlers={}),this.hasTransaction()){if(tran=this.transaction,"readonly"==tran.mode&&"readonly"!=mode)throw new Error("Active transaction is read-only and it can't be promoted to another mode.");if("readonly"==tran.mode||"readwrite"==tran.mode){if(stores){if(stores.length<1)throw new Error("Object store(s) expected.")}else stores=this.database.objectStoreNames;for(var i=0;i<stores.length;++i){var store=stores[i];if(tran.objectStoreNames.indexOf(store)<0)throw new Error("There's an active transaction and the new transaction can't be integrated therein. The object store '"+store+"' isn't in the active transaction.")}}}else{if(stores){if(stores.length<1)throw new Error("Object store(s) expected.")}else stores=this.database.objectStoreNames;tran=new IndexedDBTransaction(this.database.native.transaction(stores,mode),this,stores)}return tran.addHandlers(handlers),this.transaction=tran,tran},IndexedDBConnection.prototype.hasTransaction=function(mode){var tran,res=!1;return tran=this.transaction,tran&&(res=mode?tran.mode==mode:!0),res},IndexedDBConnection.prototype.runTransaction=function(mode,op,callback){var tran;if(arguments.length<2)throw new Error("Transaction mode and operation expected.");if(this.hasTransaction())throw new Error("A transaction is active. IndexedDB can't nest transactions.");tran=this.beginTransaction(mode,{error:function(e){callback&&callback(e)},complete:function(){callback&&callback()}}),op(this.database)}}(),function(){function IndexedDBDatabase(cx,db){Object.defineProperty(this,"connection",{value:cx}),Object.defineProperty(this,"name",{value:db.name,enumerable:!0}),Object.defineProperty(this,"version",{value:db.version,enumerable:!0}),Object.defineProperty(this,"native",{value:db}),Object.defineProperty(this,"objectStoreNames",{value:[]});for(var i=0,stores=db.objectStoreNames;i<stores.length;++i)this.objectStoreNames.push(String(stores[i]))}odba.util.inherits(IndexedDBDatabase,odba.Database),Object.defineProperty(odba.indexeddb,"IndexedDBDatabase",{value:IndexedDBDatabase}),IndexedDBDatabase.prototype.__defineGetter__("transaction",function(){return this.connection.transaction}),IndexedDBDatabase.prototype.containsObjectStore=function(name){return this.native.objectStoreNames.contains(name)},IndexedDBDatabase.prototype.containsObjectStores=function(names){var res;res=!0;for(var i=0;i<names.length;++i)if(!this.containsObjectStore(names[i])){res=!1;break}return res},IndexedDBDatabase.prototype.hasTable=function(name,callback){if(arguments.length<2)throw new Error("Table name and callback expected.");callback(void 0,this.containsObjectStore(name))},IndexedDBDatabase.prototype.hasTables=function(names,callback){var res;if(arguments.length<2)throw new Error("Table names and callback expected.");if(0===names.length)res=!1;else{res=!0;for(var i=0;i<names.length;++i)if(!this.containsObjectStore(names[i])){res=!1;break}}callback(void 0,res)},IndexedDBDatabase.prototype.getTable=function(name){return new odba.indexeddb.IndexedDBTable(this,this.transaction.getObjectStore(name))},IndexedDBDatabase.prototype.findTable=function(name,callback){var table,IndexedDBTable=odba.indexeddb.IndexedDBTable;if(arguments.length<2)throw new Error("Table name and callback expected.");if(this.containsObjectStore(name)){var tran;tran=this.connection.beginTransaction({error:function(e){callback(e)}}),table=new IndexedDBTable(this,tran.getObjectStore(name))}callback(void 0,table)},IndexedDBDatabase.prototype.createTable=function(name,options,callback){var tran,IndexedDBTable=odba.indexeddb.IndexedDBTable,util=odba.util;if(arguments.length<1)throw new Error("Table name expected.");if(2==arguments.length&&arguments[1]instanceof Function&&(callback=arguments[1],options=void 0),options=util._extend({},options),options.hasOwnProperty("id")&&!options.hasOwnProperty("keyPath")&&(options.keyPath=options.id),tran=this.transaction,!tran)return void(callback&&callback(new Error("Database.createTable() only into Connection.createDatabase() or Connection.alterDatabase().")));if(this.native.objectStoreNames.contains(name))callback&&callback(new Error("Object store '"+name+"' already exists."));else{var store=this.native.createObjectStore(name,options);callback&&callback(void 0,new IndexedDBTable(this,store))}},IndexedDBDatabase.prototype.createTables=function(stores,callback){var tran,IndexedDBTable=odba.indexeddb.IndexedDBTable,res=[];if(tran=this.transaction,!tran)return void(callback&&callback(new Error("Database.createTables() only into Connection.createDatabase() or Connection.alterDatabase().")));for(var i=0;i<stores.length;++i){var store=stores[i];res.push(new IndexedDBTable(this,this.native.createObjectStore(store.name,store)))}callback&&callback(void 0,res)},IndexedDBDatabase.prototype.dropTable=function(name,callback){var tran;return this.connection.hasTransaction("versionchange")?(tran=this.connection.transaction,this.containsObjectStore(name)&&this.native.deleteObjectStore(name),void(callback&&callback())):void(callback&&callback(new Error("Database.dropTable() only into Connection.alterDatabase().")))},IndexedDBDatabase.prototype.findIndex=function(table,index,callback){var tran,store,ix,IndexedDBTable=odba.indexeddb.IndexedDBTable;if(arguments.length<3)throw new Error("Table name, index name and callback expected.");if(this.containsObjectStore(table)&&(tran=this.activeTransaction||this.native.transaction([table],"readonly"),store=tran.objectStore(table),store.indexNames.contains(index))){var tab=new IndexedDBTable(this,store);ix=tab.indexes[index]}callback(void 0,ix)},IndexedDBDatabase.prototype.hasIndex=function(table,ix,callback){var tran,res;if(arguments.length<3)throw new Error("Table name, index name and callback expected.");if(this.containsObjectStore(table)){tran=this.connection.beginTransaction(void 0,table),tran.on("error",function(e){callback(e)});var store=tran.getObjectStore(table);res=store.indexNames.contains(ix)}else res=!1;callback(void 0,res)},IndexedDBDatabase.prototype.createIndex=function(table,index,col,options,callback){var tran,store;if(arguments.length<3)throw new Error("Table name, index name and indexing column name expected.");4==arguments.length&&arguments[3]instanceof Function&&(callback=arguments[3],options=void 0),this.connection.hasTransaction("versionchange")?(tran=this.transaction,this.containsObjectStore(table)?(store=tran.getObjectStore(table),store.indexNames.contains(index)?callback&&callback(new Error("Index '"+index+"' on '"+table+"' already exists.")):(store.createIndex(index,col,options),callback&&callback())):callback&&callback(new Error("Object store '"+table+"' doesn't exist."))):callback&&callback(new Error("Database.createIndex() only into Connection.createDatabase() or Connection.alterDatabase()."))},IndexedDBDatabase.prototype.dropIndex=function(table,index,callback){var tran,store;if(arguments.length<2)throw new Error("Table name and index name expected.");this.connection.hasTransaction("versionchange")?(tran=this.transaction,this.containsObjectStore(table)&&(store=tran.getObjectStore(table),store.indexNames.contains(index)&&store.deleteIndex(index)),callback&&callback()):callback&&callback(new Error("Database.dropIndex() only into Connection.alterDatabase()."))}}(),function(){function IndexedDBDriver(){IndexedDBDriver.super_.call(this,"IndexedDB")}odba.util.inherits(IndexedDBDriver,odba.Driver),Object.defineProperty(odba.indexeddb,"IndexedDBDriver",{value:IndexedDBDriver}),odba.Driver.register(new IndexedDBDriver),IndexedDBDriver.prototype.createConnection=function(config){if(!config)throw new Error("Configuration expected.");if(!config.database)throw new Error("Database name expected.");return new odba.indexeddb.IndexedDBConnection(config)}}(),function(){function IndexedDBIndex(store,ix){Object.defineProperty(this,"table",{value:store}),Object.defineProperty(this,"name",{value:ix.name}),Object.defineProperty(this,"column",{value:ix.keyPath}),Object.defineProperty(this,"unique",{value:ix.unique}),Object.defineProperty(this,"native",{value:ix})}odba.util.inherits(IndexedDBIndex,odba.Index),Object.defineProperty(odba.indexeddb,"IndexedDBIndex",{value:IndexedDBIndex}),IndexedDBIndex.prototype.__defineGetter__("database",function(){return this.table.database}),IndexedDBIndex.prototype.__defineGetter__("connection",function(){return this.table.connection})}(),function(){function IndexedDBQuery(table){Object.defineProperty(this,"sourceTable",{value:table}),Object.defineProperty(this,"sourceColumn",{value:void 0,writable:!0}),Object.defineProperty(this,"targetTable",{value:void 0,writable:!0}),Object.defineProperty(this,"targetColumn",{value:void 0,writable:!0}),Object.defineProperty(this,"filter",{value:{},writable:!0})}odba.util.inherits(IndexedDBQuery,odba.Query),Object.defineProperty(odba.indexeddb,"IndexedDBQuery",{value:IndexedDBQuery}),IndexedDBQuery.prototype.isSimpleQuery=function(){return!this.isCompoundQuery()},IndexedDBQuery.prototype.isCompoundQuery=function(){return!!this.targetTable},IndexedDBQuery.prototype.findAll=function(callback){if(!callback)throw new Error("Callback expected.");(new odba.indexeddb.QueryEngine).run(this,callback)},IndexedDBQuery.prototype.find=function(filter,callback){if(arguments[0]instanceof Function&&!callback&&(callback=arguments[0],filter=void 0),!callback)throw new Error("Callback expected.");this.filter=filter,(new odba.indexeddb.QueryEngine).run(this,callback)},IndexedDBQuery.prototype.findOne=function(filter,callback){if(arguments[0]instanceof Function&&!callback&&(callback=arguments[0],filter=void 0),!callback)throw new Error("Callback expected.");this.find(filter,function(error,result){error?callback(error):callback(void 0,result.length>0?result.rows[0]:void 0)})},IndexedDBQuery.prototype.join=function(target,col1,col2,callback){if(!target||!col1)throw new Error("Target table and join column expected.");return arguments[2]instanceof Function&&(callback=arguments[2],col2=void 0),col2||(col2=col1),this.sourceColumn=col1,this.targetTable=target,this.targetColumn=col2,callback?void this.find(callback):this}}(),function(){function QueryEngine(){}Object.defineProperty(odba.indexeddb,"QueryEngine",{value:QueryEngine}),QueryEngine.prototype.__defineGetter__("combinator",function(){return new odba.Combinator}),QueryEngine.prototype.__defineGetter__("filter",function(){return new odba.ResultFilter}),QueryEngine.prototype.run=function(query,callback){query.filter||(query.filter={}),query.isSimpleQuery()?this.runSimpleQuery(query,callback):this.runCompoundQuery(query,callback)},QueryEngine.prototype.runSimpleQuery=function(query,callback){this.find(query,callback)},QueryEngine.prototype.runCompoundQuery=function(query,callback){var IndexedDBResult=odba.indexeddb.IndexedDBResult,self=this;this.find(query,function(error,result){var src;error?callback(error):(src=result.rows,query.sourceTable.database.findTable(query.targetTable,function(error,tab){error?callback(error):tab.find(query.filter,function(error,result){error?callback(error):callback(void 0,new IndexedDBResult(self.combinator.join(src,result.rows,query.sourceColumn,query.targetColumn,{arrayAgg:query.targetTable+"s"})))})}))})},QueryEngine.prototype.findAll=function(query,callback){var table,tran,req,IndexedDBResult=odba.indexeddb.IndexedDBResult,records=[];table=query.sourceTable,tran=table.connection.beginTransaction({error:function(e){callback(e)},complete:function(){callback(void 0,new IndexedDBResult(records))}}),req=tran.getObjectStore(table.name).openCursor(),req.onsuccess=function(e){var crs=e.target.result;crs&&(records.push(crs.value),crs.continue())}},QueryEngine.prototype.find=function(query,callback){var table,fields;if(table=query.sourceTable,fields=Object.keys(query.filter),0===fields.length)this.findAll(query,callback);else if(1==fields.length){var field=fields[0];field==table.keyPath?this.findByKeyPath(query,callback):table.indexed[field]?this.findByIndex(query,callback):this.findByFilter(query,callback)}else this.findByFilter(query,callback)},QueryEngine.prototype.findByFilter=function(query,callback){var IndexedDBResult=odba.indexeddb.IndexedDBResult;if(0===Object.keys(query.filter).length)this.findAll(query,callback);else{var table,tran,req,self=this,records=[];table=query.sourceTable,tran=table.connection.beginTransaction({error:function(e){callback(e)},complete:function(){callback(void 0,new IndexedDBResult(records))}}),req=tran.getObjectStore(table.name).openCursor(),req.onsuccess=function(e){var crs=e.target.result;if(crs){var rec=crs.value;self.filter.check(rec,query.filter)&&records.push(rec),crs.continue()}}}},QueryEngine.prototype.getIDBKeyRange=function(op,filter){var rg;return"$eq"==op?rg=IDBKeyRange.only(filter.$eq):"$lt"==op?rg=IDBKeyRange.upperBound(filter.$lt,!0):"$le"==op?rg=IDBKeyRange.upperBound(filter.$le):"$gt"==op?rg=IDBKeyRange.lowerBound(filter.$gt,!0):"$ge"==op&&(rg=IDBKeyRange.lowerBound(filter.$ge)),rg},QueryEngine.prototype.findByKeyPath=function(query,callback){var table,filter,rg,IndexedDBResult=odba.indexeddb.IndexedDBResult;if(table=query.sourceTable,filter=query.filter[Object.keys(query.filter)[0]],"object"!=typeof filter)rg=IDBKeyRange.only(filter);else{var op=Object.keys(filter);1==op.length&&(rg=this.getIDBKeyRange(op[0],filter))}if(rg){var tran,req,records=[];tran=table.connection.beginTransaction({error:function(e){callback(e)},complete:function(){callback(void 0,new IndexedDBResult(records,{byKey:!0}))}}),req=tran.getObjectStore(table.name).openCursor(rg),req.onerror=function(e){callback(e)},req.onsuccess=function(e){var crs=e.target.result;crs&&(records.push(crs.value),crs.continue())}}else this.findByFilter(query.filter,callback)},QueryEngine.prototype.findByIndex=function(query,callback){var table,key,ix,filter,where,rg,IndexedDBResult=odba.indexeddb.IndexedDBResult;if(table=query.sourceTable,where=query.filter,key=Object.keys(where)[0],ix=table.indexed[key],filter=where[key],"object"!=typeof filter)rg=IDBKeyRange.only(filter);else{var op=Object.keys(filter);1==op.length&&(rg=this.getIDBKeyRange(op[0],filter))}if(rg){var tran,req,records=[];tran=table.connection.beginTransaction({error:function(e){callback(e)},complete:function(){callback(void 0,new IndexedDBResult(records,{byIndex:!0}))}}),req=tran.getObjectStore(table.name).index(ix.name).openCursor(rg),req.onerror=function(e){callback(e)},req.onsuccess=function(e){var crs=e.target.result;crs&&(records.push(crs.value),crs.continue())}}else this.findByFilter(where,callback)}}(),function(){function IndexedDBResult(records,options){options||(options={}),options.byKey||(options.byKey=!1),options.byIndex||(options.byIndex=!1),IndexedDBResult.super_.call(this,records),Object.defineProperty(this,"byKey",{value:options.byKey}),Object.defineProperty(this,"byIndex",{value:options.byIndex})}odba.util.inherits(IndexedDBResult,odba.Result),Object.defineProperty(odba.indexeddb,"IndexedDBResult",{value:IndexedDBResult})}(),function(){function IndexedDBServer(cx){IndexedDBServer.super_.call(this),Object.defineProperty(this,"connection",{value:cx})}odba.util.inherits(IndexedDBServer,odba.Server),Object.defineProperty(odba.indexeddb,"IndexedDBServer",{value:IndexedDBServer}),IndexedDBServer.prototype.__defineGetter__("host",function(){return"localhost"}),IndexedDBServer.prototype.__defineGetter__("port",function(){throw new Error("Unsupported property.")}),IndexedDBServer.prototype.__defineGetter__("version",function(){throw new Error("Unsupported property.")}),IndexedDBServer.prototype.createDatabase=function(name,ddl,callback){var req,IndexedDBDatabase=odba.indexeddb.IndexedDBDatabase,IndexedDBTransaction=odba.indexeddb.IndexedDBTransaction,cx=this.connection,indexedDB=cx.indexedDB;if(!name||"string"!=typeof name)throw new Error("Database name expected.");if(cx.connected)throw new Error("Connection opened.");req=indexedDB.open(name),req.onupgradeneeded=function(e){cx.transaction=new IndexedDBTransaction(e.currentTarget.transaction,cx),cx.database=new IndexedDBDatabase(cx,e.target.result),ddl&&ddl(cx.database)},req.onsuccess=function(){cx.close(callback)},req.onerror=function(e){cx.close(function(){callback&&callback(e)})}},IndexedDBServer.prototype.dropDatabase=function(name,callback){if(!name||"string"!=typeof name)throw new Error("Database name expected.");this.connection.indexedDB.deleteDatabase(name),this.connection.close(callback)},IndexedDBServer.prototype.alterDatabase=function(name,ddl,callback){var req,IndexedDBDatabase=odba.indexeddb.IndexedDBDatabase,IndexedDBTransaction=odba.indexeddb.IndexedDBTransaction,cx=this.connection,indexedDB=cx.indexedDB;if(!name||"string"!=typeof name)throw new Error("Database name expected.");if(!ddl)throw new Error("Operation to alter schema expected.");if(cx.connected)throw new Error("Connection opened.");req=indexedDB.open(name),req.onerror=function(e){callback&&callback(e)},req.onsuccess=function(e){var version,req,db=e.target.result;version=db.version+1,db.close(),req=indexedDB.open(name,version),req.onupgradeneeded=function(e){cx.database=new IndexedDBDatabase(cx,e.target.result),cx.transaction=new IndexedDBTransaction(e.currentTarget.transaction,cx),ddl(cx.database)},req.onerror=function(e){cx.close(function(){callback&&callback(e)})},req.onsuccess=function(){cx.close(callback)}}},IndexedDBServer.prototype.hasDatabase=function(name,callback){var req,cx=this.connection,indexedDB=cx.indexedDB,util=odba.util;if(!name||"string"!=typeof name)throw new Error("Database name expected.");if(!callback)throw new Error("Callback expected.");if("Chrome"==util.getBrowserName())req=indexedDB.webkitGetDatabaseNames(),req.onsuccess=function(e){callback(void 0,e.target.result.contains(name))},req.onerror=function(e){callback(e)};else{var existed=!0;req=indexedDB.open(name),req.onupgradeneeded=function(){existed=!1},req.onsuccess=function(){req.result.close(),existed&&indexedDB.deleteDatabase(name),callback(void 0,existed)}}}}(),function(){function IndexedDBTable(db,store){var IndexedDBIndex=odba.indexeddb.IndexedDBIndex,indexes={},indexed={};Object.defineProperty(this,"database",{value:db,enumerable:!0}),Object.defineProperty(this,"name",{value:store.name,enumerable:!0}),Object.defineProperty(this,"keyPath",{value:store.keyPath,enumerable:!0}),Object.defineProperty(this,"autoIncrement",{value:store.autoIncrement,enumerable:!0}),Object.defineProperty(this,"connection",{value:db.connection}),Object.defineProperty(this,"indexes",{value:indexes}),Object.defineProperty(this,"indexed",{value:indexed});for(var i=0;i<store.indexNames.length;++i){var ixName=store.indexNames[i],ix=new IndexedDBIndex(this,store.index(ixName));indexes[ixName]=ix,indexed[ix.column]=ix}}odba.util.inherits(IndexedDBTable,odba.Table),Object.defineProperty(odba.indexeddb,"IndexedDBTable",{value:IndexedDBTable}),IndexedDBTable.prototype.__defineGetter__("transaction",function(){return this.connection.transaction}),IndexedDBTable.prototype.hasIndex=function(name,callback){if(arguments.length<2)throw new Error("Index name and callback expected.");this.database.hasIndex(this.name,name,callback)},IndexedDBTable.prototype.findIndex=function(name,callback){if(arguments.length<2)throw new Error("Index name and callback expected.");this.database.findIndex(this.name,name,callback)},IndexedDBTable.prototype.createIndex=function(name,col,options,callback){if(arguments.length<2)throw new Error("Index name and indexing column expected.");3==arguments.length&&arguments[2]instanceof Function&&(callback=arguments[2],options={}),this.database.createIndex(this.name,name,col,options,callback)},IndexedDBTable.prototype.dropIndex=function(name,callback){if(arguments.length<1)throw new Error("Index name expected.");
this.database.dropIndex(this.name,name,callback)},IndexedDBTable.prototype.query=function(){return new odba.indexeddb.IndexedDBQuery(this)},IndexedDBTable.prototype.find=function(where,callback){this.query().find(where,callback)},IndexedDBTable.prototype.findAll=function(callback){this.query().findAll(callback)},IndexedDBTable.prototype.findOne=function(where,callback){this.query().findOne(where,callback)},IndexedDBTable.prototype.count=function(callback){if(!callback)throw new Error("Callback expected.");this.findAll(function(error,result){error?callback(error):callback(void 0,result.length)})},IndexedDBTable.prototype.join=function(target,col1,col2,callback){return this.query().join(target,col1,col2,callback)},IndexedDBTable.prototype.insert=function(records,callback){function add(i){var req;if(i<records.length)try{req=store.add(records[i]),req.onsuccess=function(){add(i+1)}}catch(e){abortError=e,tran.rollback()}}var tran,store,abortError;if(arguments.length<1)throw new Error("Object(s) to insert expected.");return records?(tran=this.connection.beginTransaction(void 0,this.name),tran.on("abort",function(){abortError&&callback&&callback(new Error(abortError.message))}),tran.on("error",function(e){callback&&callback(e instanceof Error?e:new Error(e.message))}),tran.on("complete",function(){callback&&callback()}),store=tran.getObjectStore(this.name),records instanceof Array||(records=[records]),void add(0)):void(callback&&callback(new Error("Object to insert can't be null or undefined.")))},IndexedDBTable.prototype.save=function(records,callback){var tran;if(arguments.length<1)throw new Error("Object to update expected.");if(1==arguments.length&&"object"!=typeof records)throw new Error("Object to update expected.");records instanceof Array||(records=[records]),tran=this.connection.beginTransaction(void 0,this.name),tran.on("error",function(e){callback&&callback(e)}),tran.on("complete",function(){callback&&callback()});for(var i=0;i<records.length;++i)tran.getObjectStore(this.name).put(records[i])},IndexedDBTable.prototype.update=function(where,fields,callback){var Updater=odba.indexeddb.Updater,self=this;if(arguments.length<1)throw new Error("Fields expected.");if(1==arguments.length){if(arguments[0]instanceof Function)throw new Error("Fields expected.");fields=arguments[0],where=callback=void 0}else 2==arguments.length&&arguments[1]instanceof Function&&(callback=arguments[1],fields=arguments[0],where=void 0);this.find(where,function(error,result){return error?callback(error):((new Updater).update(result.rows,fields),void self.save(result.rows,callback))})},IndexedDBTable.prototype.remove=function(where,callback){var tran,store,req;if(1==arguments.length&&arguments[0]instanceof Function&&(callback=arguments[0],where=void 0),tran=this.connection.beginTransaction(void 0,this.name),tran.on("complete",function(){callback&&callback()}),store=tran.getObjectStore(this.name),where&&0!==Object.keys(where).length){if(Object.keys(where).indexOf(this.keyPath)<0)throw new Error("Key path expected.");req=store.delete(where[this.keyPath]),req.onerror=function(e){callback&&callback(e)}}else req=store.clear(),req.onerror=function(e){callback&&callback(e)}}}(),function(){function IndexedDBTransaction(tran,cx,stores,handlers){var self=this;Object.defineProperty(this,"native",{value:tran}),Object.defineProperty(this,"connection",{value:cx}),Object.defineProperty(this,"abortHandlers",{value:[]}),Object.defineProperty(this,"errorHandlers",{value:[]}),Object.defineProperty(this,"completeHandlers",{value:[]}),Object.defineProperty(this,"state",{value:"active",writable:!0}),Object.defineProperty(this,"objectStoreNames",{value:stores}),tran.onerror=function(e){self.connection.transaction=void 0,self.handleErrorEvent(e)},tran.onabort=function(e){self.connection.transaction=void 0,self.handleAbortEvent(e)},tran.oncomplete=function(e){self.connection.transaction=void 0,self.handleCompleteEvent(e)},handlers&&(handlers.error&&this.on("error",handlers.error),handlers.abort&&this.on("abort",handlers.abort),handlers.complete&&this.on("complete",handlers.complete))}Object.defineProperty(odba.indexeddb,"IndexedDBTransaction",{value:IndexedDBTransaction}),IndexedDBTransaction.prototype.__defineGetter__("mode",function(){return this.native.mode}),IndexedDBTransaction.prototype.__defineGetter__("database",function(){return this.connection.database}),IndexedDBTransaction.prototype.on=function(event,handler){if(1==arguments.length){var handlers=arguments[0];handlers.abort?this.on("abort",handlers.abort):handlers.error?this.on("error",handlers.error):handlers.complete&&this.on("complete",handlers.complete)}else"abort"==event?this.abortHandlers.push(handler):"error"==event?this.errorHandlers.push(handler):"complete"==event&&this.completeHandlers.push(handler)},IndexedDBTransaction.prototype.addHandlers=function(handlers){if(handlers)for(var i=0,events=Object.keys(handlers);i<events.length;++i){var event=events[i],handler=handlers[event];this.on(event,handler)}},IndexedDBTransaction.prototype.handleErrorEvent=function(e){this.state="aborted";for(var i=0,handlers=this.errorHandlers;i<handlers.length;++i)handlers[i](e)},IndexedDBTransaction.prototype.handleAbortEvent=function(e){this.state="error";for(var i=0,handlers=this.abortHandlers;i<handlers.length;++i)handlers[i](e)},IndexedDBTransaction.prototype.handleCompleteEvent=function(e){this.state="committed";for(var i=0,handlers=this.completeHandlers;i<handlers.length;++i)handlers[i](e)},IndexedDBTransaction.prototype.getObjectStore=function(name){if(("readonly"==this.mode||"readwrite"==this.mode)&&this.objectStoreNames.indexOf(name)<0)throw new Error("The active transaction only can access to the following object stores: "+(this.objectStores||"no specified")+".");return this.native.objectStore(name)},IndexedDBTransaction.prototype.getTable=function(name){return new odba.indexeddb.IndexedDBTable(this.database,this.getObjectStore(name))},IndexedDBTransaction.prototype.rollback=function(){this.native.abort()}}(),function(){function Updater(){}Object.defineProperty(odba.indexeddb,"Updater",{value:Updater}),Updater.prototype.update=function(records,fields){for(var i=0;i<records.length;++i)this.updateRecord(records[i],fields)},Updater.prototype.updateRecord=function(record,fields){for(var i=0,props=Object.keys(fields);i<props.length;++i){var prop=props[i],val=fields[prop];this.updateField(record,prop,val)}},Updater.prototype.updateField=function(record,prop,expr){function hasModifier(expr){var res;if("object"!=typeof expr)res=!1;else{var props=Object.keys(expr);res=1==props.length?/^\$.+/.test(props[0]):!1}return res}if(hasModifier(expr)){var mod=Object.keys(expr)[0],val=expr[mod];if("$set"==mod)this.$set(record,prop,val);else if("$inc"==mod)this.$inc(record,prop,val);else if("$dec"==mod)this.$dec(record,prop,val);else{if("$mul"!=mod)throw new Error("Invalid update modifier: '"+mod+"'.");this.$mul(record,prop,val)}}else this.$set(record,prop,expr)},Updater.prototype.$set=function(record,prop,value){record[prop]=value},Updater.prototype.$inc=function(record,prop,value){record[prop]+=value},Updater.prototype.$dec=function(record,prop,value){record[prop]-=value},Updater.prototype.$mul=function(record,prop,value){record[prop]*=value}}();